#!/bin/bash

MAC2EUI64=/usr/bin/mac2eui64

source /etc/default/snf-network

source $CONF
source $STATE_DIR/infra

host=$(hostname)
domain=$(hostname -d)


if [ "$GANETI_INSTANCE_PRIMARY" = "$host.$domain" ]; then

  NETWORK=$GANETI_INSTANCE_NIC0_NETWORK
  NETWORK_TYPE=$GANETI_INSTANCE_NIC0_NETWORK_TYPE
  MODE=$GANETI_INSTANCE_NIC0_MODE
  LINK=$GANETI_INSTANCE_NIC0_LINK
  MAC=$GANETI_INSTANCE_NIC0_MAC
  SUBNET6=$GANETI_INSTANCE_NIC0_NETWORK_SUBNET6
  TAGS=$GANETI_INSTANCE_NIC0_NETWORK_TAGS  

  for tag in $TAGS; do
    case tag in
    ip-less-routed)
      EUI64=$($MAC2EUI64 $MAC $SUBNET6 2>/dev/null)
      ip -6 neigh del proxy $EUI64 dev $PUBLIC_VLAN >/dev/null 2>&1
    ;;
    esac
  done
fi

exit 0
